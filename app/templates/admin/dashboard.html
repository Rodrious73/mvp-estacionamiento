{% extends "base.html" %}

{% block title %}Panel Administrativo - Dashboard{% endblock %}

{% block extra_css %}
<style>
    .admin-theme {
        --primary-color: #dc3545;
        --secondary-color: #6c757d;
        --accent-color: #ffc107;
        --bg-gradient: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }
    
    .admin-header {
        background: var(--bg-gradient);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 0 0 15px 15px;
    }
    
    .stats-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-left: 4px solid var(--primary-color);
        transition: transform 0.3s ease;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
    }
    
    .stats-icon {
        font-size: 2rem;
        color: var(--primary-color);
    }
    
    .stats-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: var(--primary-color);
        margin: 0;
    }
    
    .stats-label {
        color: #6c757d;
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
    
    .admin-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .quick-action {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        text-decoration: none;
        color: #495057;
        transition: all 0.3s ease;
    }
    
    .quick-action:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
        transform: translateY(-2px);
        text-decoration: none;
    }
    
    .quick-action i {
        font-size: 2rem;
        margin-bottom: 1rem;
        display: block;
    }
    
    .admin-nav {
        background: white;
        border-radius: 15px;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .admin-nav .nav-link {
        color: #495057;
        font-weight: 500;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .admin-nav .nav-link:hover,
    .admin-nav .nav-link.active {
        background: var(--primary-color);
        color: white;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        background: white;
        border-radius: 15px;
        padding: 1rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .activity-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid #e9ecef;
        transition: background-color 0.3s ease;
    }
    
    .activity-item:hover {
        background: #f8f9fa;
    }
    
    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        color: white;
    }
    
    .activity-icon.pendiente {
        background: #ffc107;
    }
    
    .activity-icon.aprobada {
        background: #28a745;
    }
    
    .activity-icon.rechazada {
        background: #dc3545;
    }
    
    .alert-admin {
        border-left: 4px solid var(--primary-color);
        background: #fff5f5;
        border-color: #fed7d7;
    }
    
    .badge-admin {
        background: var(--primary-color);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-theme">
    <!-- Header -->
    <div class="admin-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="mb-0">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Panel Administrativo
                    </h1>
                    <p class="mb-0 mt-2 opacity-75">
                        Gestión del sistema de estacionamientos
                    </p>
                </div>
                <div class="col-md-6 text-end">
                    <div class="d-flex align-items-center justify-content-end">
                        <i class="fas fa-user-shield me-2"></i>
                        <span>{{ current_user.name if current_user else 'Administrador' }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Navegación -->
        <nav class="admin-nav">
            <ul class="nav nav-pills">
                <li class="nav-item">
                    <a class="nav-link active" href="{{ url_for('admin.dashboard') }}">
                        <i class="fas fa-home me-2"></i>Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('admin.solicitudes') }}">
                        <i class="fas fa-file-alt me-2"></i>Solicitudes
                        {% if solicitudes_pendientes > 0 %}
                            <span class="badge bg-warning text-dark ms-1">{{ solicitudes_pendientes }}</span>
                        {% endif %}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('admin.usuarios') }}">
                        <i class="fas fa-users me-2"></i>Usuarios
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('admin.vehiculos') }}">
                        <i class="fas fa-car me-2"></i>Vehículos
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('admin.pases') }}">
                        <i class="fas fa-id-card me-2"></i>Pases
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('admin.reportes') }}">
                        <i class="fas fa-chart-bar me-2"></i>Reportes
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('admin.ciclos') }}">
                        <i class="fas fa-calendar-alt me-2"></i>Ciclos
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Estadísticas principales -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon me-3">
                            <i class="fas fa-users"></i>
                        </div>
                        <div>
                            <div class="stats-number">{{ total_usuarios }}</div>
                            <div class="stats-label">Total Usuarios</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon me-3">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div>
                            <div class="stats-number">{{ solicitudes_pendientes }}</div>
                            <div class="stats-label">Solicitudes Pendientes</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon me-3">
                            <i class="fas fa-id-card"></i>
                        </div>
                        <div>
                            <div class="stats-number">{{ pases_activos }}</div>
                            <div class="stats-label">Pases Activos</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon me-3">
                            <i class="fas fa-car"></i>
                        </div>
                        <div>
                            <div class="stats-number">{{ total_vehiculos }}</div>
                            <div class="stats-label">Total Vehículos</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Acciones rápidas -->
        <div class="admin-card">
            <h3 class="mb-3">
                <i class="fas fa-bolt me-2"></i>Acciones Rápidas
            </h3>
            <div class="quick-actions">
                <a href="{{ url_for('admin.solicitudes', estado='pendiente') }}" class="quick-action">
                    <i class="fas fa-clock"></i>
                    <div>Solicitudes Pendientes</div>
                    <small class="text-muted">{{ solicitudes_pendientes }} por revisar</small>
                </a>
                <a href="{{ url_for('admin.usuarios') }}" class="quick-action">
                    <i class="fas fa-user-plus"></i>
                    <div>Gestionar Usuarios</div>
                    <small class="text-muted">{{ total_usuarios }} registrados</small>
                </a>
                <a href="{{ url_for('admin.reportes') }}" class="quick-action">
                    <i class="fas fa-chart-line"></i>
                    <div>Ver Reportes</div>
                    <small class="text-muted">Estadísticas detalladas</small>
                </a>
                <a href="{{ url_for('admin.ciclos') }}" class="quick-action">
                    <i class="fas fa-calendar-check"></i>
                    <div>Ciclos Académicos</div>
                    <small class="text-muted">{% if ciclo_actual %}{{ ciclo_actual.nombre }}{% else %}Sin ciclo activo{% endif %}</small>
                </a>
            </div>
        </div>

        <div class="row">
            <!-- Gráfico de solicitudes -->
            <div class="col-md-8">
                <div class="admin-card">
                    <h4 class="mb-3">
                        <i class="fas fa-chart-area me-2"></i>Solicitudes por Estado
                    </h4>
                    <div class="chart-container">
                        <canvas id="solicitudesChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Actividad reciente -->
            <div class="col-md-4">
                <div class="admin-card">
                    <h4 class="mb-3">
                        <i class="fas fa-history me-2"></i>Actividad Reciente
                    </h4>
                    <div class="activity-list">
                        {% for solicitud in actividad_reciente %}
                        <div class="activity-item">
                            <div class="activity-icon {{ solicitud.estado }}">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div class="flex-grow-1">
                                <strong>{{ solicitud.usuario.nombre }}</strong>
                                <div class="small text-muted">
                                    Solicitud {{ solicitud.tipo }} - {{ solicitud.estado }}
                                </div>
                                <div class="small text-muted">
                                    {{ solicitud.fecha_solicitud.strftime('%d/%m/%Y %H:%M') }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Información del sistema -->
        <div class="row">
            <div class="col-md-6">
                <div class="admin-card">
                    <h4 class="mb-3">
                        <i class="fas fa-info-circle me-2"></i>Información del Sistema
                    </h4>
                    <div class="row">
                        <div class="col-6">
                            <strong>Estudiantes:</strong> {{ estudiantes }}
                        </div>
                        <div class="col-6">
                            <strong>Docentes:</strong> {{ docentes }}
                        </div>
                        <div class="col-12 mt-2">
                            <strong>Solicitudes (7 días):</strong> {{ solicitudes_recientes }}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="admin-card">
                    <h4 class="mb-3">
                        <i class="fas fa-calendar-alt me-2"></i>Ciclo Académico
                    </h4>
                    {% if ciclo_actual %}
                    <div class="alert alert-admin">
                        <strong>{{ ciclo_actual.nombre }}</strong><br>
                        <small>
                            {{ ciclo_actual.fecha_inicio.strftime('%d/%m/%Y') }} - 
                            {{ ciclo_actual.fecha_fin.strftime('%d/%m/%Y') }}
                        </small>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No hay ciclo académico activo
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Gráfico de solicitudes por estado
const ctx = document.getElementById('solicitudesChart').getContext('2d');
const solicitudesChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: [
            {% for estado, cantidad in solicitudes_por_estado.items() %}
                '{{ cantidad }}',
            {% endfor %}
        ],
        datasets: [{
            data: [
                {% for estado, cantidad in solicitudes_por_estado.items()%}
                    {{ cantidad }},
                {% endfor %}
            ],
            backgroundColor: [
                '#ffc107',
                '#28a745',
                '#dc3545',
                '#6c757d'
            ],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20
                }
            }
        }
    }
});

// Actualizar estadísticas cada 30 segundos
setInterval(function() {
    fetch('{{ url_for("admin.api_estadisticas") }}')
        .then(response => response.json())
        .then(data => {
            console.log('Estadísticas actualizadas:', data);
        })
        .catch(error => console.error('Error:', error));
}, 30000);
</script>
{% endblock %}
